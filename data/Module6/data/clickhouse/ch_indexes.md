## 6.2.8 Primary Key и индексирование в ClickHouse

### [Назад к ClickHouse ⤶](/data/Module6/data/clickhouse.md)

> ***Первичный ключ*** — уникальный идентификатор строки в таблице, который определяет порядок хранения данных.  

> ***Сортировка*** — определяет, в каком порядке строки физически располагаются внутри таблицы. В **ClickHouse** это 
`primary key` или `ORDER BY`.  

> ***Индекс*** — вторичная структура, которая предназначена для быстрого поиска и фильтрации данных по определённым 
критериям без необходимости полного сканирования таблицы.  

## 1. Типы индексов в ClickHouse
- _**Primary Key Index** (индекс по первичному ключу)_  
  - Используется для упорядочивания данных в **MergeTree**-таблицах.  
  - Основывается на выражении `ORDER BY` при создании таблицы.  
  - Не обеспечивает уникальности, но значительно ускоряет диапазонные запросы и фильтрацию по ключу сортировки.  
- _**Skip Indexes** (пропускающие индексы, data skipping indexes)_  
  - Позволяют пропустить чтение блоков данных, которые не содержат искомых значений.
  - Виды _skip_-индексов:  
    - **minmax** — индексирует минимальные и максимальные значения для определённых столбцов в каждом блоке данных.  
    - **set** — хранит уникальные значения в блоке; эффективен для столбцов с небольшим числом уникальных значений.  
    - **bloom_filter** — использует фильтр Блума для эффективных проверок вхождения значения в столбце.  
  - Skip-индексы задаются через секцию `INDEX` при создании таблицы.  
- _**Secondary Indices** (вторичные индексы)_  
  - В классическом понимании в **ClickHouse** отсутствуют, однако _skip_-индексы частично выполняют их роль.  
- **Гранулярность индекса**  
  - Параметр, определяющий, на каком уровне (например, на сколько строк) действует индекс.  
  - Влияет на баланс между производительностью запросов и размером индекса.  

## 2. Принципы работы индексов в ClickHouse
- **ClickHouse** хранит данные в виде частей _(parts)_, каждая из которых состоит из блоков строк фиксированного 
размера _(гранул)_.  
- Индексы позволяют быстро определять, какие блоки содержат потенциально релевантные данные для запроса.  
- Если индекс позволяет исключить часть данных, чтение этих блоков не производится.  
- Индексы не гарантируют исключение всех нерелевантных блоков, но существенно уменьшают объём сканируемых данных.  

## 3. Реализация индексов в ClickHouse
#### Primary Key Index
Primary key формируется на основе выражения `ORDER BY`:

```sql
CREATE TABLE events
(
    event_date Date,
    user_id UInt32,
    event_type String
)
ENGINE = MergeTree
ORDER BY (event_date, user_id);
```
                  
- Данные физически хранятся отсортированными по `event_date` и `user_id`.  
- Запросы с фильтрами по этим полям работают наиболее эффективно.  