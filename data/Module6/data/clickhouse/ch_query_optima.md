## 6.2.12 Оптимизация SQL-запросов в ClickHouse

### [Назад к ClickHouse ⤶](/data/Module6/data/clickhouse.md)

## Ключевые понятия
- **План выполнения запроса** — описание последовательности операций, выполняемых при обработке запроса.  
- **Фильтрация данных** — применение условий, ограничивающих количество обрабатываемых строк.  
- **Агрегация** — вычисление сводных значений по группам данных.  
- **Сортировка** — упорядочивание данных по одному или нескольким столбцам.  
- **Джойны (соединения)** — объединение данных из разных таблиц по определённым условиям.  
- **Партиционирование** — физическое разбиение таблицы на части по определённому ключу.  
- **Индексы** — структуры данных для ускорения выборки строк.  
- **Векторизация** — обработка данных пакетами для повышения производительности.  

## Принципы оптимизации SQL-запросов в ClickHouse
1. Минимизация объёма обрабатываемых данных.  
2. Использование возможностей колоночного хранения и архитектурных особенностей **ClickHouse**.  
3. Эффективное использование партиционирования, сортировки и индексов.  
4. Оптимизация структуры запросов: порядка операций, типов соединений, агрегаций и фильтраций.  
5. Применение специализированных функций и синтаксических конструкций **ClickHouse**.  

## Основные подходы к оптимизации
### 1. Фильтрация данных
Фильтрация должна выполняться как можно раньше. Это сокращает объём обрабатываемых данных на последующих этапах. 
В ClickHouse фильтрация реализуется через `WHERE` и `PREWHERE`.  

```sql
PREWHERE выполняет фильтрацию до декомпрессии и чтения неиспользуемых столбцов, что позволяет экономить ресурсы.
SELECT col1, col2
FROM table
PREWHERE date >= '2024-01-01'
WHERE status = 'active'
```
                  
Рекомендуется помещать в `PREWHERE` наиболее селективные (сильно ограничивающие выборку) условия по столбцам, 
входящим в сортировочный ключ.  

### 2. Использование сортировочного ключа и партиционирования
Сортировочный ключ (`ORDER BY`) и партиционирование (`PARTITION BY`) позволяют ограничить сканируемый объём данных.  

```sql
CREATE TABLE visits
(
    user_id UInt32,
    event_date Date,
    event_type String,
    ...
)
ENGINE = MergeTree
PARTITION BY toYYYYMM(event_date)
ORDER BY (user_id, event_date)
```
                  
В запросах рекомендуется использовать условия по полям, входящим в `ORDER BY` и `PARTITION BY`.  
Это позволяет **ClickHouse** быстро определять, какие партиции и диапазоны строк нужно читать.  

```sql
SELECT count(*)
FROM visits
WHERE event_date BETWEEN '2024-05-01' AND '2024-05-31'
  AND user_id = 12345
```