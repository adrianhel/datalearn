## 6.2.9 Сжатие данных в ClickHouse

### [Назад к ClickHouse ⤶](/data/Module6/data/clickhouse.md)

Сжатие данных — фундаментальный механизм оптимизации хранения и ускорения обработки больших объемов информации 
в аналитических СУБД.  

> _**Сжатие данных** (data compression)_ — процесс кодирования информации с целью уменьшения ее объема для хранения 
> или передачи.  

В контексте **ClickHouse** сжатие данных применяется при сохранении данных на диск, что позволяет:  
- Сократить требования к объему хранения.  
- Снизить расходы на ввод-вывод (I/O) при чтении данных.  
- Увеличить пропускную способность системы при обработке аналитических запросов.  

## 1. Алгоритмы сжатия, поддерживаемые ClickHouse
**ClickHouse** поддерживает несколько алгоритмов сжатия, которые можно выбирать в зависимости от сценариев использования:
- **LZ4** — алгоритм по умолчанию. Предлагает хороший баланс между скоростью сжатия/разжатия и коэффициентом сжатия.  
Оптимален для большинства рабочих нагрузок.  
- **ZSTD (Zstandard)** — обеспечивает более высокий коэффициент сжатия по сравнению с LZ4, но с меньшей скоростью 
сжатия/разжатия.  
Подходит для архивирования или сценариев, где важна минимизация занимаемого пространства.  
- **NONE** — отсутствие сжатия.  
Используется для специфических задач, где важна максимальная скорость доступа к данным, 
а объем хранения не критичен.  

#### Пример использования алгоритма сжатия ZSTD с уровнем 3

```sql
CREATE TABLE example
(
    id UInt32,
    name String,
    value Float64
)
ENGINE = MergeTree()
ORDER BY id
SETTINGS index_granularity = 8192,
         compression = 'ZSTD(3)';
```

## 2. Внутренние кодеки сжатия
- **ClickHouse** поддерживает специфические кодеки для сжатия отдельных столбцов или типов данных:
- **Delta** — для хранения разностей между последовательными значениями. Эффективен для монотонно возрастающих/убывающих 
числовых последовательностей.  
- **DoubleDelta** — хранит разности разностей, используется для данных с равномерным приростом (например, временные 
метки с постоянным шагом).  
- **Gorilla** — специализированный кодек для сжатия временных рядов и числовых данных с малым изменением между значениями.  
- **Dictionary** — создает словарь уникальных значений и заменяет их индексами; эффективен для строковых столбцов с 
малым числом уникальных значений.  
- **LowCardinality** — оптимизация для строковых столбцов с низким числом уникальных значений.  
- **Sparse** — эффективен для столбцов с большим числом нулевых или одинаковых значений.  

#### Пример задания кодека для столбца

```sql
CREATE TABLE timeseries
(
    event_time DateTime CODEC(Delta, LZ4),
    value Float64 CODEC(Gorilla)
)
ENGINE = MergeTree()
ORDER BY event_time;
```

## 3. Комбинирование кодеков
**ClickHouse** позволяет комбинировать несколько кодеков для одного столбца. Обычно сначала применяется 
специализированный кодек (например, **Delta** или **Dictionary**), а затем — общий алгоритм сжатия (например, **LZ4** 
или **ZSTD**).  

Типичная последовательность применения кодеков:  
- Преобразование данных специализированным кодеком (например, вычисление дельт).  
- Сжатие общего назначения (например, **LZ4**).  

#### Пример комбинированного сжатия  

```sql
CREATE TABLE sensor_data
(
    timestamp DateTime CODEC(DoubleDelta, ZSTD(5)),
    temperature Float32 CODEC(Gorilla, ZSTD(1))
)
ENGINE = MergeTree()
ORDER BY timestamp;
```