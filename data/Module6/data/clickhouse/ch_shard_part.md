## 6.2.7 Сегментация и партиционирование в ClickHouse

### [Назад к ClickHouse ⤶](/data/Module6/data/clickhouse.md)

> _**Сегментация** (шардирование, sharding) — разделение данных на независимые сегменты, которые могут храниться и 
> обрабатываться на различных физических или логических узлах кластера._  

> _**Партиционирование** (partitioning) — логическое деление данных внутри одной таблицы на отдельные части (партиции), 
> обычно на основе значений одних или нескольких столбцов._  

Эти подходы обеспечивают эффективное хранение, быстрый поиск, масштабируемость и параллелизм при выполнении 
аналитических запросов.  

## 1. Принципы сегментации
Сегментация позволяет горизонтально масштабировать хранилище, распределяя данные по множеству серверов. 
В **ClickHouse** сегментация реализуется с помощью распределённых таблиц и механизма `Distributed`. 
Каждый сегмент _(shard)_ содержит подмножество строк таблицы.  

- **Горизонтальное масштабирование** достигается за счет добавления новых узлов с отдельными сегментами.  
- **Параллелизм обработки** — запросы могут выполняться одновременно на разных сегментах.  
- **Отказоустойчивость** — за счет репликации сегментов обеспечивается сохранность данных.  

#### Формула распределения строки по сегментам

$$ shard\_number = hash(key\_column)\ \%\ number\_of\_shards $$

где $key\_column$ — выбранный для шардирования столбец, $number\_of\_shards$ — общее количество сегментов.  

#### Пример создания распределённой таблицы

```sql
CREATE TABLE hits_local (
    date Date,
    user_id UInt64,
    url String
) ENGINE = MergeTree()
ORDER BY (date, user_id);

CREATE TABLE hits_dist AS hits_local
ENGINE = Distributed(
    'cluster_name', 'default', 'hits_local', user_id
);
```

В данном примере строки распределяются по сегментам на основе хэш-функции от `user_id`.

## 2. Принципы партиционирования
**Партиционирование** — механизм логического деления таблицы на партиции по определённому критерию. 
В **ClickHouse** партиционирование реализуется на уровне движка **MergeTree** и его наследников.  

- **Партиция (partition)** — независимый набор данных, объединённых по ключу партиционирования.  
- **Ключ партиционирования** задаётся при создании таблицы с помощью выражения `PARTITION BY`.  
- **Внутрипартиционный порядок** обеспечивается с помощью `ORDER BY`.  

Преимущества партиционирования:  
- Быстрое удаление или архивация данных по партиции.  
- Ускорение запросов, использующих фильтрацию по полям партиционирования.  
- Снижение объема обрабатываемых данных за счет **pruning** (отсечения неактуальных партиций на этапе выполнения запроса).  

#### Пример создания таблицы с партиционированием

```sql
CREATE TABLE events (
    event_date Date,
    event_type String,
    user_id UInt64
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(event_date)
ORDER BY (event_type, user_id);
```

В данном примере данные группыруются в партиции по месяцу события `toYYYYMM(event_date)`.  

Удаление партиции возможно одной командой:  

```sql
ALTER TABLE events DROP PARTITION 202405;
```