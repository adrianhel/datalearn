## 4.5.3 Исполнители и пулы (Executors & Pools)

### [Назад к Airflow ⤶](/data/Module4/data/airflow.md)

> ***Executor*** - модуль, который отвечает за выполнение задач и степень распределенности системы.

Он управляет тем, каким образом задачи будут доставляться до _воркеров_, а также может использовать различные 
стратегии для обработки параллелизма и распределения нагрузки.  

*Executor* позволяет обрабатывать задачи параллельно или последовательно. Мы не работаем с ним напрямую, лишь 
указываем, какой механизм выполнения задач хотим использовать при установке. Это происходит единожды.

### Основные типы Executors
- **SequentialExecutor**
- **LocalExecutor**
- **CeleryExecutor**
- **KubernetesExecutor**

### SequentialExecutor
_Sequential Executor_ это самый простой экзекьютор, который используется для выполнения задач в последовательном порядке.  
При установке **Airflow** на свой ПК этот экзекьютор будет использоваться по умолчанию.  

#### Как работает
Работа экзекьютора сильно зависит от установленной БД. Для этого экзекьютора используется **SQLite** — это самая простая 
БД, которая работает только на клиенте и хранится на вашем локальном компьютере. Создается автоматически при установке.  
Экзекьютор, не позволяет исполнять задачи параллельно. Поэтому, все задачи в _DAG_ будут выполняться последовательно.

<p align="center">
    <img src="/data/Module4/img/seq_exe.png" width="40%">
</p>

_Под капотом_, когда мы используем данный тип экзекьютора, все задачи помещаются в список. Мы проходим по этому списку 
обычным циклом и запускаем задачи одну за другой. В данном случае **Worker** = **Executor**.

#### Когда использовать
**Тестирование**: _При разработке и тестировании DAG для упрощения отладки._  
**Небольшие рабочие нагрузки**: _Если задачи не требуют высокой производительности и могут выполняться последовательно._ 

### LocalExecutor & Pools
В данном типе экзекьютора используется клиент-серверная база данных — **PostgreSQL** по умолчанию.  

#### Как работает
Особенностью данного экзекьютора является то, что все задачи исполняются на одном сервере, на одном компьютере. 
При этом задачи могут выполняться параллельно: для каждой конкретной задачи создается отдельный процесс.  

<p align="center">
    <img src="/data/Module4/img/loc_exe.png" width="40%">
</p>

Если две задачи должны исполниться параллельно, они будут выполняться параллельно. Однако у такого исполнения есть 
свои особенности. Если мы работаем на одном сервере, а количество наших задач растёт и растёт, то большое количество 
параллельных задач начинает сильно тормозить работу нашей системы. Эту проблему можно решить с помощью _пулов_. 

#### Пулы
> **Пулы (Pools)** — это механизм управления ресурсами, который позволяет ограничивать количество одновременно 
выполняемых задач в зависимости от определенных критериев.  

_Пулы_ помогают избежать перегрузки системы и обеспечивают более эффективное распределение ресурсов между задачами.  

Принцип их действия очень простой: давайте создадим дополнительную очередь, которая не будет пропускать больше задач 
к _воркерам_, чем нужно.  

#### Создание пула
Пул можно создать вручную через веб-интерфейс **Airflow**. Чтобы поместить задачу в пул, нужно указать дополнительный 
аргумент, в котором вы указываете, что эта задача принадлежит данному пулу. По умолчанию этот показатель равен 128.  

Пример указания пула в даге. Вручную был создан Pool `Admin` -> `Pools`

```python
task_1= BashOperator(
    task_id='task_1',
    pool='non_default_pool',
    bash_command="sleep 10",
    dag=dag,
)
```

#### Проблема пулов
Очевидная проблема _пулов_ — это то, что мы не контролируем порядок исполнения задач. Но проблема эта решаема — можно
задать веса, чтобы некоторые задачи исполнялись раньше других.

```python
task_1= BashOperator(
    task_id='task_1',
    pool='non_default_pool',
    bash_command="sleep 10",
    priority_weight=3,        # Чем выше вес тем раньше будет исполнена задача
    dag=dag,
)

task_2= BashOperator(
    task_id='task_2',
    pool='non_default_pool',
    bash_command="sleep 10",
    priority_weight=5,        # Чем выше вес тем раньше будет исполнена задача
    dag=dag,
)
```

В _DAG_ выше, сначала выполнится `task_2`, потом `task_1`.

### CeleryExecutor
Использует систему распределенных задач **Celery** для выполнения задач на нескольких рабочих узлах. **Airflow** 
установлен на _мастер-узле_, а задачи исполняются на других машинах. Позволяет горизонтально масштабировать выполнение 
задач, что делает его подходящим для больших рабочих нагрузок.  

<p align="center">
    <img src="/data/Module4/img/cel_exe.gif" width="50%">
</p>

### KubernetesExecutor
Позволяет запускать задачи в контейнерах **Kubernetes**. Идеален для облачных сред и микросервисной архитектуры. 
Является наиболее подходящим для больших проектов и продакшн решений. Работает примерно по такому же принципу, 
как и _CeleryExecutor_.  